<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Dashboard | Personal Finance Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar {
            background-color: #f8f9fa;
            height: 100vh;
            position: sticky;
            top: 0;
            padding-top: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
            padding: 10px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: none;
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 15px 20px;
        }
        .card-header h5 {
            margin: 0;
            font-weight: 600;
            color: #333;
        }
        .card-body {
            padding: 20px;
        }
        .nav-link {
            color: #495057;
            border-radius: 0;
            padding: 10px 15px;
        }
        .nav-link.active {
            background-color: #e9ecef;
            font-weight: bold;
        }
        .dashboard-header {
            background-color: #343a40;
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
        }
        .category-badge {
            font-size: 0.9rem;
            margin: 3px;
            padding: 5px 10px;
            display: inline-block;
            border-radius: 0.25rem;
            font-weight: 500;
        }
        .stats-card {
            background-color: #f8f9fa;
            border-left: 4px solid #0d6efd;
            padding: 15px;
            border-radius: 5px;
            transition: transform 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .loading-chart {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 10;
            opacity: 1;
            transition: opacity 0.4s ease;
        }
        
        .loading-chart.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #0d6efd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky">
                    <h4 class="p-3">Finance Tracker</h4>
                    <hr>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#overview">Overview</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#transactions">Transactions</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#categories">Categories</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#trends">Trends</a>
                        </li>
                    </ul>
                    <hr>
                    <div class="p-3">
                        <a href="/merchants" class="btn btn-outline-primary btn-sm w-100 mb-2">Merchant Management</a>
                        <a href="/" class="btn btn-outline-secondary btn-sm w-100 mb-2">Back to Home</a>
                        <button id="clear-cache-btn" class="btn btn-outline-danger btn-sm w-100">Clear PDF Cache</button>
                    </div>
                </div>
            </div>

            <!-- Main content -->
            <div class="col-md-9 col-lg-10 ms-sm-auto px-md-4">
                <div class="dashboard-header">
                    <div class="container">
                        <h1>Finance Dashboard</h1>
                        <p>View and analyze your financial data</p>
                    </div>
                </div>

                <!-- Overview Section -->
                <section id="overview" class="mb-5">
                    <h2>Overview</h2>
                    <div id="status-message"></div>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Balance Over Time</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <div id="balanceChartLoader" class="loading-chart">
                                            <div class="loading-spinner"></div>
                                        </div>
                                        <canvas id="balanceChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Spending by Category</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <div id="categoryChartLoader" class="loading-chart">
                                            <div class="loading-spinner"></div>
                                        </div>
                                        <canvas id="categoryChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Milestones Section -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Financial Milestones</h5>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showProjectionToggle">
                                        <label class="form-check-label" for="showProjectionToggle">Show Projections</label>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <div id="milestoneChartLoader" class="loading-chart">
                                            <div class="loading-spinner"></div>
                                        </div>
                                        <canvas id="milestoneChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Transactions Section -->
                <section id="transactions" class="mb-5">
                    <h2>Recent Transactions</h2>
                    <div class="card mt-4">
                        <div class="card-body">
                            <!-- Date Range Filter -->
                            <div class="row mb-4">
                                <div class="col-md-10">
                                    <div class="row g-3">
                                        <div class="col-md-5">
                                            <label for="start-date" class="form-label">Start Date</label>
                                            <input type="date" id="start-date" class="form-control">
                                        </div>
                                        <div class="col-md-5">
                                            <label for="end-date" class="form-label">End Date</label>
                                            <input type="date" id="end-date" class="form-control">
                                        </div>
                                        <div class="col-md-2 d-flex align-items-end">
                                            <button id="apply-date-filter" class="btn btn-primary">Apply Filter</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Amount</th>
                                            <th>Category</th>
                                            <th>Account</th>
                                            <th>Account Balance</th>
                                            <th>Overall Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactions-table-body">
                                        <tr>
                                            <td colspan="7" class="text-center">Loading transactions...</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div>
                                        <span id="transaction-count-display">Showing 0 of 0 transactions</span>
                                    </div>
                                    <div>
                                        <button id="prev-page-btn" class="btn btn-sm btn-outline-primary me-2" disabled>Previous</button>
                                        <button id="next-page-btn" class="btn btn-sm btn-outline-primary" disabled>Next</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Categories Section -->
                <section id="categories" class="mb-5">
                    <h2>Spending Categories</h2>
                    <div class="card mt-4">
                        <div class="card-body">
                            <div id="categories-container" class="d-flex flex-wrap">
                                <p class="text-center w-100">Loading categories...</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Trends Section -->
                <section id="trends" class="mb-5">
                    <h2>Spending Trends</h2>
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5>Monthly Spending Trends</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="trendsChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PELT Trend Analysis -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5>Balance Trend Analysis (PELT Algorithm)</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">
                                This chart uses the PELT algorithm to detect significant changes in your balance trend. Vertical lines indicate breakpoints between different financial periods.
                            </p>
                            <div class="chart-container">
                                <canvas id="peltChart"></canvas>
                            </div>
                            <div class="mt-4">
                                <h6>Rate of Change Analysis</h6>
                                <div class="chart-container">
                                    <canvas id="rateOfChangeChart"></canvas>
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <span class="badge bg-success me-1">Green</span> Positive rate (increasing balance)
                                        <span class="badge bg-danger ms-3 me-1">Red</span> Negative rate (decreasing balance)
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set up status display
            const statusMessage = document.getElementById('status-message');
            statusMessage.innerHTML = '<div class="alert alert-info">Loading your financial data...</div>';
            
            // Fetch data and populate the dashboard - ensure categories is loaded first
            Promise.all([
                fetchCategories(),  // Get categories first for color consistency
                fetchBalanceChart(),
                fetchBalanceData(), // Add milestone chart initialization
                fetchTransactions(),
                fetchMonthlyTrends(),
                fetchPeltAnalysis()
            ])
            .then(() => {
                statusMessage.innerHTML = '<div class="alert alert-success">Data loaded successfully!</div>';
                // Hide status message after 3 seconds
                setTimeout(() => {
                    statusMessage.innerHTML = '';
                }, 3000);
            })
            .catch(error => {
                statusMessage.innerHTML = `<div class="alert alert-danger">Error loading data: ${error.message}</div>`;
            });
            
            // Event listeners for date filter
            document.getElementById('apply-date-filter').addEventListener('click', function() {
                fetchTransactions();
            });
            
            // Event listener for cache clearing
            document.getElementById('clear-cache-btn').addEventListener('click', function() {
                clearPDFCache();
            });
            
            // Navigation tabs
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Remove active class from all links
                    navLinks.forEach(l => l.classList.remove('active'));
                    // Add active class to clicked link
                    this.classList.add('active');
                    // Show the corresponding section
                    const targetId = this.getAttribute('href').substring(1);
                    document.querySelectorAll('section').forEach(section => {
                        section.style.display = 'none';
                    });
                    document.getElementById(targetId).style.display = 'block';
                });
            });
            
            // Initialize pagination
            initPagination();
        });
        
        // Transactions page variables
        let allTransactions = [];
        let currentPage = 1;
        const transactionsPerPage = 20;
            
        function fetchTransactions() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            let url = '/api/transactions';
            const params = new URLSearchParams();
            
            if (startDate) {
                params.append('start_date', startDate);
            }
            
            if (endDate) {
                params.append('end_date', endDate);
            }
            
            // Append parameters to URL if they exist
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            document.getElementById('transactions-table-body').innerHTML = '<tr><td colspan="7" class="text-center">Loading transactions...</td></tr>';
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch transactions');
                    }
                    return response.json();
                })
                .then(data => {
                    if (Array.isArray(data)) {
                        allTransactions = data;
                        displayTransactions(currentPage);
                        document.getElementById('transaction-count-display').innerText = `Showing ${Math.min(transactionsPerPage, data.length)} of ${data.length} transactions`;
                        updatePaginationButtons();
                    } else {
                        throw new Error('Invalid data format received');
                    }
                })
                .catch(error => {
                    console.error('Error fetching transactions:', error);
                    document.getElementById('transactions-table-body').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading transactions: ' + error.message + '</td></tr>';
                });
        }
            
        function displayTransactions(page) {
            const startIndex = (page - 1) * transactionsPerPage;
            const endIndex = startIndex + transactionsPerPage;
            const pageTransactions = allTransactions.slice(startIndex, endIndex);
            
            const tableBody = document.getElementById('transactions-table-body');
            tableBody.innerHTML = '';
            
            if (pageTransactions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No transactions found in this date range.</td></tr>';
                return;
            }
            
            pageTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                
                // Debug logging
                console.log('Processing transaction:', transaction);
                
                // Format date
                const date = new Date(transaction.DateTime);
                const formattedDate = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                
                // Format amount - preserve original sign and format
                const amount = parseFloat(transaction.Amount);
                const formattedAmount = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(Math.abs(amount));
                const amountClass = amount < 0 ? 'text-danger' : 'text-success';
                const amountPrefix = amount < 0 ? '-' : '+';
                
                // Debug logging for balance values
                console.log('Balance values:', {
                    accountBalance: {
                        raw: transaction.Account_Balance,
                        type: typeof transaction.Account_Balance,
                        isNull: transaction.Account_Balance === null,
                        isUndefined: transaction.Account_Balance === undefined,
                        isNaN: isNaN(transaction.Account_Balance)
                    },
                    overallBalance: {
                        raw: transaction.Overall_Balance,
                        type: typeof transaction.Overall_Balance,
                        isNull: transaction.Overall_Balance === null,
                        isUndefined: transaction.Overall_Balance === undefined,
                        isNaN: isNaN(transaction.Overall_Balance)
                    }
                });
                
                // Format balances with more careful type checking
                let accountBalanceDisplay = '-';
                if (transaction.Account_Balance !== null && 
                    transaction.Account_Balance !== undefined && 
                    !isNaN(parseFloat(transaction.Account_Balance))) {
                    accountBalanceDisplay = new Intl.NumberFormat('en-US', { 
                        style: 'currency', 
                        currency: 'USD' 
                    }).format(parseFloat(transaction.Account_Balance));
                }
                
                let overallBalanceDisplay = '-';
                if (transaction.Overall_Balance !== null && 
                    transaction.Overall_Balance !== undefined && 
                    !isNaN(parseFloat(transaction.Overall_Balance))) {
                    overallBalanceDisplay = new Intl.NumberFormat('en-US', { 
                        style: 'currency', 
                        currency: 'USD' 
                    }).format(parseFloat(transaction.Overall_Balance));
                }
                
                // Debug logging for formatted values
                console.log('Formatted values:', {
                    accountBalanceDisplay,
                    overallBalanceDisplay
                });
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${transaction.Details || ''}</td>
                    <td class="${amountClass}">${amountPrefix}${formattedAmount}</td>
                    <td>${transaction.Classification || 'Uncategorized'}</td>
                    <td>${transaction.Account_Name || ''}</td>
                    <td>${accountBalanceDisplay}</td>
                    <td>${overallBalanceDisplay}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
            
        function initPagination() {
            document.getElementById('prev-page-btn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayTransactions(currentPage);
                    updatePaginationButtons();
                }
            });
            
            document.getElementById('next-page-btn').addEventListener('click', () => {
                const maxPages = Math.ceil(allTransactions.length / transactionsPerPage);
                if (currentPage < maxPages) {
                    currentPage++;
                    displayTransactions(currentPage);
                    updatePaginationButtons();
                }
            });
        }
            
        function updatePaginationButtons() {
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            const maxPages = Math.ceil(allTransactions.length / transactionsPerPage);
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === maxPages || maxPages === 0;
        }
        
        function clearPDFCache() {
            if (!confirm('Are you sure you want to clear the PDF cache? You will need to reprocess all PDFs next time.')) {
                return;
            }
            
            fetch('/api/clear_cache', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('PDF cache cleared successfully');
                        // Force a hard reload of the page to ensure fresh data
                        window.location.href = window.location.href;
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error clearing cache:', error);
                    alert('Error clearing cache. See console for details.');
                });
        }
        
        async function fetchBalanceChart() {
            try {
                const response = await fetch('/api/balance-chart');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                renderBalanceChart(data);
                return data;
            } catch (error) {
                console.error('Error fetching balance chart data:', error);
                throw error;
            }
        }
        
        async function fetchPeltAnalysis() {
            try {
                const response = await fetch('/api/pelt-analysis');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                renderPeltChart(data);
                renderRateOfChangeChart(data.rateOfChange);
                return data;
            } catch (error) {
                console.error('Error fetching PELT analysis data:', error);
                throw error;
            }
        }
        
        function renderBalanceChart(data) {
            const ctx = document.getElementById('balanceChart').getContext('2d');
            
            // Clean up any existing chart
            const existingChart = Chart.getChart(ctx.canvas);
            if (existingChart) {
                existingChart.destroy();
            }

            // Gradient fill for the area below the line
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(187, 37, 37, 0.3)');  // Semi-transparent red at top
            gradient.addColorStop(1, 'rgba(187, 37, 37, 0.01)'); // Almost transparent at bottom
            
            // Enhance the dataset with better styling
            if (data.datasets && data.datasets.length > 0) {
                data.datasets[0].borderColor = 'rgba(187, 37, 37, 0.8)';
                data.datasets[0].backgroundColor = gradient;
                data.datasets[0].borderWidth = 2;
                data.datasets[0].pointRadius = 0;
                data.datasets[0].pointHoverRadius = 6;
                data.datasets[0].pointHoverBackgroundColor = 'rgba(187, 37, 37, 1)';
                data.datasets[0].pointHoverBorderColor = 'white';
                data.datasets[0].pointHoverBorderWidth = 2;
                data.datasets[0].tension = 0.3; // Add slight curve to the line
                data.datasets[0].fill = true;
            }
            
            // Create chart with improved options
            const chart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1500, // Smoother animation
                        easing: 'easeOutQuart',
                        onComplete: function() {
                            // Hide loader when animation is complete
                            document.getElementById('balanceChartLoader').classList.add('hidden');
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            type: 'category',
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxTicksLimit: 8,
                                color: '#666',
                                font: {
                                    family: 'Inter',
                                    size: 11
                                }
                            }
                        },
                        y: {
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    family: 'Inter',
                                    size: 11
                                },
                                callback: function(value) {
                                    return new Intl.NumberFormat('en-US', {
                                        style: 'currency',
                                        currency: 'USD',
                                        maximumFractionDigits: 0
                                    }).format(value);
                                }
                            },
                            title: {
                                display: true,
                                text: 'Balance',
                                color: '#666',
                                font: {
                                    family: 'Inter',
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            titleFont: {
                                family: 'Inter',
                                size: 12
                            },
                            bodyFont: {
                                family: 'Inter',
                                size: 12
                            },
                            callbacks: {
                                label: function(context) {
                                    return 'Balance: ' + new Intl.NumberFormat('en-US', {
                                        style: 'currency',
                                        currency: 'USD'
                                    }).format(context.raw);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        async function fetchCategories() {
            try {
                const response = await fetch('/api/categories');
                if (!response.ok) {
                    throw new Error('Failed to fetch categories');
                }
                
                const categories = await response.json();
                
                if (categories.error) {
                    throw new Error(categories.error);
                }
                
                // Render the categories list
                renderCategories(categories.counts || {}, categories.colors || {});
                
                // Render the category chart with spending data
                renderCategoryChart(categories.spending || {}, categories.colors || {});
                
                // Show a message if there's no spending data but it was expected
                if (categories.has_spending_data === false) {
                    console.warn("No spending data available - check that you have transactions with negative amounts");
                    // Add a small warning to the chart area
                    const chartContainer = document.querySelector('#categoryChart').parentNode;
                    const warningEl = document.createElement('div');
                    warningEl.className = 'small text-warning text-center mt-2';
                    warningEl.textContent = 'Note: No expense transactions found to display in chart';
                    chartContainer.appendChild(warningEl);
                }
                
                // Store colors globally for other charts to use
                window.categoryColors = categories.colors || {};
                
                return true;
            } catch (error) {
                console.error('Error fetching categories:', error);
                document.getElementById('categories-container').innerHTML = 
                    '<div class="alert alert-danger w-100">Failed to load categories: ' + error.message + '</div>';
                renderCategoryChart(null); // Ensure chart shows the "no data" state
                return false;
            }
        }
        
        function renderCategories(categories, categoryColors) {
            const container = document.getElementById('categories-container');
            container.innerHTML = '';
            
            if (Object.keys(categories).length === 0) {
                container.innerHTML = '<p class="text-center w-100">No categories found</p>';
                return;
            }
            
            // Use provided colors from API instead of predefined colors
            let index = 0;
            for (const category in categories) {
                const badge = document.createElement('div');
                const bgColor = categoryColors && categoryColors[category] ? categoryColors[category] : '#607D8B';
                
                // Apply the color directly as inline style
                badge.className = 'category-badge';
                badge.style.backgroundColor = bgColor;
                badge.style.color = 'white';
                badge.innerHTML = `${category}: ${categories[category]}`;
                
                container.appendChild(badge);
                index++;
            }
        }
        
        function renderCategoryChart(categoryData, categoryColors) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            // If we already have a chart, destroy it to prevent duplicates
            const existingChart = Chart.getChart(ctx.canvas);
            if (existingChart) {
                existingChart.destroy();
            }
            
            // If no real data yet, show placeholder
            if (!categoryData || Object.keys(categoryData).length === 0) {
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['No spending data available'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#f0f0f0'],
                            borderColor: '#e0e0e0',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        family: 'Inter',
                                        size: 12
                                    },
                                    padding: 15,
                                    color: '#666'
                                }
                            },
                            tooltip: {
                                enabled: false
                            }
                        },
                        animation: {
                            animateScale: true,
                            animateRotate: true,
                            duration: 1000,
                            easing: 'easeOutQuart',
                            onComplete: function() {
                                // Hide loader even for placeholder
                                document.getElementById('categoryChartLoader').classList.add('hidden');
                            }
                        }
                    }
                });
                return;
            }
            
            // Sort categories by spend amount (descending)
            const sortedEntries = Object.entries(categoryData)
                .sort((a, b) => b[1] - a[1]);
            
            const labels = sortedEntries.map(entry => entry[0]);
            const data = sortedEntries.map(entry => entry[1]);
            
            // Calculate total for percentages
            const total = data.reduce((sum, value) => sum + value, 0);
            
            // Use provided category colors or fallback to defaults
            const colors = labels.map(label => 
                categoryColors && categoryColors[label] ? categoryColors[label] : '#607D8B'
            );
            
            // Add slight transparency to colors for better aesthetic
            const backgroundColors = colors.map(color => {
                // If color is hex, convert to rgba
                if (color.startsWith('#')) {
                    const r = parseInt(color.slice(1, 3), 16);
                    const g = parseInt(color.slice(3, 5), 16);
                    const b = parseInt(color.slice(5, 7), 16);
                    return `rgba(${r},${g},${b},0.85)`;
                }
                // If already rgba, just return
                return color;
            });
            
            // Slightly darker colors for hover state
            const hoverColors = backgroundColors.map(color => {
                if (color.startsWith('rgba')) {
                    return color.replace('0.85', '1');
                }
                return color;
            });
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        hoverBackgroundColor: hoverColors,
                        borderColor: 'white',
                        borderWidth: 2,
                        hoverBorderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    layout: {
                        padding: 15
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true,
                        duration: 1500,
                        easing: 'easeOutQuart',
                        onComplete: function() {
                            // Hide loader when animation is complete
                            document.getElementById('categoryChartLoader').classList.add('hidden');
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    family: 'Inter',
                                    size: 12
                                },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                color: '#666',
                                // Limit the number of legend items shown if there are too many
                                filter: function(legendItem, data) {
                                    // Only show top categories that make up 95% of spending plus "Other"
                                    const index = legendItem.index;
                                    const value = data.datasets[0].data[index];
                                    const percentage = (value / total) * 100;
                                    
                                    // Always show top 6 categories regardless of percentage
                                    if (index < 6) return true;
                                    
                                    // Show categories with at least 3% of total spend
                                    return percentage >= 3;
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            titleFont: {
                                family: 'Inter',
                                size: 13,
                                weight: 'bold'
                            },
                            bodyFont: {
                                family: 'Inter',
                                size: 12
                            },
                            padding: 12,
                            cornerRadius: 6,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${new Intl.NumberFormat('en-US', {
                                        style: 'currency',
                                        currency: 'USD'
                                    }).format(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Add total spending text in the center of the doughnut
            if (total > 0) {
                setTimeout(() => {
                    const chartArea = document.querySelector('#categoryChart').parentNode;
                    let centerText = chartArea.querySelector('.doughnut-center-text');
                    
                    if (!centerText) {
                        centerText = document.createElement('div');
                        centerText.className = 'doughnut-center-text';
                        centerText.style.position = 'absolute';
                        centerText.style.top = '50%';
                        centerText.style.left = '50%';
                        centerText.style.transform = 'translate(-50%, -50%)';
                        centerText.style.textAlign = 'center';
                        centerText.style.pointerEvents = 'none';
                        centerText.style.fontFamily = 'Inter, sans-serif';
                        
                        chartArea.style.position = 'relative';
                        chartArea.appendChild(centerText);
                    }
                    
                    const formattedTotal = new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        maximumFractionDigits: 0
                    }).format(total);
                    
                    centerText.innerHTML = `
                        <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Total Spending</div>
                        <div style="font-size: 18px; font-weight: 600; color: #333;">${formattedTotal}</div>
                    `;
                }, 100);
            }
        }
        
        function renderTrendsChart(data = null) {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            // If we already have a chart, destroy it to prevent duplicates
            const existingChart = Chart.getChart(ctx.canvas);
            if (existingChart) {
                existingChart.destroy();
            }
            
            // If no real data yet, show placeholder
            if (!data) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Loading...'],
                        datasets: [{
                            label: 'Monthly Spending',
                            data: [0],
                            backgroundColor: '#cccccc'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                return;
            }
            
            // Apply consistent colors to datasets if available
            if (window.categoryColors) {
                data.datasets.forEach(dataset => {
                    // Only apply color if it's a category dataset (not income or net)
                    if (dataset.label !== 'Income' && dataset.label !== 'Net' && window.categoryColors[dataset.label]) {
                        dataset.backgroundColor = window.categoryColors[dataset.label];
                    }
                    // Special case for Income
                    if (dataset.label === 'Income' && window.categoryColors['Income']) {
                        dataset.backgroundColor = window.categoryColors['Income'];
                    }
                });
            }
            
            // Create chart with real data
            new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw || 0;
                                    return `${label}: $${Math.abs(value).toFixed(2)}`;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                // Limit the number of legends displayed
                                filter: function(legendItem, data) {
                                    // Only show important categories and Income/Net
                                    if (legendItem.text === 'Income' || 
                                        legendItem.text === 'Net' || 
                                        data.datasets[legendItem.datasetIndex].data.reduce((a, b) => Math.abs(a) + Math.abs(b), 0) > 100) {
                                        return true;
                                    }
                                    return false;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                autoSkip: true,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount ($)'
                            }
                        }
                    }
                }
            });
        }
        
        async function fetchMonthlyTrends() {
            try {
                const response = await fetch('/api/monthly-trends');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                renderTrendsChart(data);
                return data;
            } catch (error) {
                console.error('Error fetching monthly trends data:', error);
                throw error;
            }
        }
        
        function renderPeltChart(data) {
            const ctx = document.getElementById('peltChart').getContext('2d');
            
            // Clean up any existing chart
            const existingChart = Chart.getChart(ctx.canvas);
            if (existingChart) {
                existingChart.destroy();
            }
            
            // If no data or error, show placeholder
            if (!data || data.error || !data.datasets || data.datasets.length === 0) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['No data available'],
                        datasets: [{
                            data: [0],
                            borderColor: '#ccc',
                            borderDash: [5, 5]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
                return;
            }
            
            // Create the chart with improved options
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: data.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    elements: {
                        line: {
                            tension: 0.3 // Add slight curve to lines
                        }
                    },
                    scales: {
                        x: {
                            type: 'category',
                            grid: {
                                color: 'rgba(0,0,0,0.05)',
                                display: true
                            },
                            title: {
                                display: true,
                                text: 'Date',
                                color: '#666',
                                font: {
                                    family: 'Inter',
                                    size: 12
                                }
                            },
                            ticks: {
                                maxTicksLimit: 8,
                                autoSkip: true,
                                maxRotation: 45,
                                minRotation: 45,
                                color: '#666',
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(0,0,0,0.05)',
                                display: true
                            },
                            title: {
                                display: true,
                                text: 'Balance',
                                color: '#666',
                                font: {
                                    family: 'Inter',
                                    size: 12
                                }
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    family: 'Inter'
                                },
                                callback: function(value) {
                                    return new Intl.NumberFormat('en-US', {
                                        style: 'currency',
                                        currency: 'USD',
                                        maximumFractionDigits: 0
                                    }).format(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            titleFont: {
                                family: 'Inter'
                            },
                            bodyFont: {
                                family: 'Inter'
                            },
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    return `${context.dataset.label}: ${new Intl.NumberFormat('en-US', {
                                        style: 'currency',
                                        currency: 'USD'
                                    }).format(value)}`;
                                }
                            },
                            displayColors: true,
                            backgroundColor: 'rgba(0,0,0,0.7)'
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Inter'
                                },
                                color: '#666',
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        }
                    }
                }
            });
            
            // Add vertical lines for change points
            if (data.changePoints && data.changePoints.length > 0) {
                const chartContainer = chart.canvas.parentNode;
                chartContainer.style.position = 'relative';
                
                // Remove any existing change point lines
                const existingLines = chartContainer.querySelectorAll('.change-point-line');
                existingLines.forEach(line => line.remove());
                
                // Add change point lines after a slight delay to ensure chart is rendered
                setTimeout(() => {
                    data.changePoints.forEach((date, index) => {
                        const dateIndex = data.labels.indexOf(date);
                        if (dateIndex === -1) return;
                        
                        const meta = chart.getDatasetMeta(0);
                        if (!meta.data[dateIndex]) return;
                        
                        const x = meta.data[dateIndex].x;
                        
                        // Create the line element
                        const line = document.createElement('div');
                        line.className = 'change-point-line';
                        line.style.position = 'absolute';
                        line.style.top = '0';
                        line.style.bottom = '0';
                        line.style.width = '1px';
                        line.style.backgroundColor = 'rgba(0, 0, 0, 0.15)';
                        line.style.left = `${x}px`;
                        line.style.pointerEvents = 'none';
                        line.style.zIndex = '10';
                        line.style.boxShadow = '0 0 2px rgba(0, 0, 0, 0.1)';
                        
                        // Add a subtle point at the top of the line
                        const point = document.createElement('div');
                        point.style.position = 'absolute';
                        point.style.top = '0';
                        point.style.left = '-2px';
                        point.style.width = '5px';
                        point.style.height = '5px';
                        point.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
                        point.style.borderRadius = '50%';
                        
                        line.appendChild(point);
                        chartContainer.appendChild(line);
                        
                        // Add date tooltip
                        line.title = `Change point: ${date}`;
                    });
                }, 200);
            }
        }
        
        function renderRateOfChangeChart(rateData) {
            const ctx = document.getElementById('rateOfChangeChart').getContext('2d');
            
            // Clean up any existing chart
            const existingChart = Chart.getChart(ctx.canvas);
            if (existingChart) {
                existingChart.destroy();
            }
            
            // If no data, show placeholder
            if (!rateData || !rateData.data || rateData.data.length === 0) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['No data available'],
                        datasets: [{
                            data: [0],
                            borderColor: '#ccc',
                            borderDash: [5, 5]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
                return;
            }
            
            // Create datasets for positive and negative values
            const positiveData = rateData.data.map(val => val > 0 ? val : null);
            const negativeData = rateData.data.map(val => val < 0 ? val : null);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: rateData.labels,
                    datasets: [
                        {
                            label: 'Positive Rate of Change',
                            data: positiveData,
                            borderColor: 'rgba(40, 167, 69, 0.8)',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: true
                        },
                        {
                            label: 'Negative Rate of Change',
                            data: negativeData,
                            borderColor: 'rgba(220, 53, 69, 0.8)',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'category',
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxTicksLimit: 8,
                                autoSkip: true,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Weekly Rate of Change ($)'
                            },
                            grid: {
                                color: function(context) {
                                    if (context.tick.value === 0) {
                                        return 'rgba(0, 0, 0, 0.5)';
                                    }
                                    return 'rgba(0, 0, 0, 0.1)';
                                },
                                lineWidth: function(context) {
                                    if (context.tick.value === 0) {
                                        return 2;
                                    }
                                    return 1;
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('en-US', {
                                        style: 'currency',
                                        currency: 'USD',
                                        maximumFractionDigits: 0
                                    }).format(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    if (value === null) return null;
                                    
                                    const sign = value >= 0 ? '+' : '';
                                    return `Rate of Change: ${sign}${new Intl.NumberFormat('en-US', {
                                        style: 'currency',
                                        currency: 'USD'
                                    }).format(value)}/week`;
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Initialize milestone chart
        let milestoneChart = null;
        const milestones = [10000, 25000, 50000, 100000, 200000, 500000, 1000000];

        function renderMilestoneChart(balanceData) {
            const ctx = document.getElementById('milestoneChart').getContext('2d');
            
            // Get the current balance from the data
            const currentBalance = balanceData && balanceData.datasets && balanceData.datasets[0] && balanceData.datasets[0].data 
                ? balanceData.datasets[0].data[0] 
                : 0;
            
            // Calculate next milestone
            const nextMilestone = milestones.find(m => m > currentBalance) || milestones[milestones.length - 1];
            const previousMilestone = milestones.filter(m => m <= currentBalance).pop() || 0;
            
            // Calculate progress percentage
            const progress = ((currentBalance - previousMilestone) / (nextMilestone - previousMilestone)) * 100;
            
            // Clean up any existing chart
            const existingChart = Chart.getChart(ctx.canvas);
            if (existingChart) {
                existingChart.destroy();
            }
            
            // Create the milestone chart
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Progress'],
                    datasets: [{
                        data: [progress, 100 - progress],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(200, 200, 200, 0.2)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '80%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    }
                }
            });
            
            // Update milestone info
            const milestoneInfo = document.createElement('div');
            milestoneInfo.className = 'text-center mt-3';
            milestoneInfo.innerHTML = `
                <div class="h4 mb-2">Current Balance: ${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(currentBalance)}</div>
                <div class="h5 mb-3">Next Milestone: ${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(nextMilestone)}</div>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: ${progress}%;" 
                         aria-valuenow="${progress}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        ${progress.toFixed(1)}%
                    </div>
                </div>
            `;
            
            // Remove any existing milestone info
            const existingInfo = document.querySelector('#milestoneChart').parentNode.querySelector('.text-center');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            document.querySelector('#milestoneChart').parentNode.appendChild(milestoneInfo);
            
            // Hide the loading spinner
            document.getElementById('milestoneChartLoader').classList.add('hidden');
        }

        // Add milestone chart initialization to the balance data fetch
        async function fetchBalanceData() {
            try {
                const response = await fetch('/api/balance-chart');
                if (!response.ok) {
                    throw new Error('Failed to fetch balance data');
                }
                const data = await response.json();
                
                if (!data || !data.datasets || !data.datasets[0] || !data.datasets[0].data) {
                    throw new Error('Invalid balance data format');
                }
                
                // Extract the last balance value from the datasets
                const lastDataset = data.datasets[0];
                const lastBalance = lastDataset.data[lastDataset.data.length - 1] || 0;
                
                // Create a simplified data object for the milestone chart
                const milestoneData = {
                    datasets: [{
                        data: [lastBalance],
                        backgroundColor: ['#4CAF50'],
                        borderColor: ['#388E3C'],
                        borderWidth: 1
                    }]
                };
                
                // Render both charts
                renderBalanceChart(data);
                renderMilestoneChart(milestoneData);
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('balanceChart').innerHTML = `<div class="alert alert-danger">Error loading data: ${error.message}</div>`;
                document.getElementById('milestoneChart').innerHTML = `<div class="alert alert-danger">Error loading data: ${error.message}</div>`;
            }
        }

        // Add projection toggle handler
        document.getElementById('showProjectionToggle').addEventListener('change', async function(e) {
            const isChecked = e.target.checked;
            if (isChecked) {
                try {
                    console.log('Fetching balance data for projection...');
                    // Fetch historical balance data to calculate growth trend
                    const response = await fetch('/api/balance-chart');
                    const data = await response.json();
                    console.log('Balance data received:', data);
                    
                    // Get the balance history from the data
                    const balanceHistory = data.datasets[0].data;
                    const dates = data.labels.map(date => new Date(date));
                    
                    console.log('First balance:', balanceHistory[0]);
                    console.log('Last balance:', balanceHistory[balanceHistory.length - 1]);
                    
                    // Calculate total growth and time period
                    const firstBalance = balanceHistory[0];
                    const lastBalance = balanceHistory[balanceHistory.length - 1];
                    const totalGrowth = lastBalance - firstBalance;
                    
                    // Calculate time difference in months
                    const monthsDiff = (dates[dates.length - 1] - dates[0]) / (1000 * 60 * 60 * 24 * 30.44);
                    console.log('Months difference:', monthsDiff);
                    
                    // Calculate average monthly growth rate
                    const monthlyGrowth = totalGrowth / monthsDiff;
                    console.log('Monthly growth rate:', monthlyGrowth);
                    
                    // Get current balance from milestone chart
                    const currentBalance = milestoneChart.data.datasets[0].data[0].x;
                    console.log('Current balance:', currentBalance);
                    
                    // Project for the next 24 months
                    const projectedPoints = [];
                    let projectedBalance = currentBalance;
                    
                    // Calculate projected time to reach each remaining milestone
                    const remainingMilestones = milestones.filter(m => m > currentBalance);
                    console.log('Remaining milestones:', remainingMilestones);
                    const timeToMilestones = {};
                    
                    for (let i = 1; i <= 24; i++) {
                        projectedBalance += monthlyGrowth;
                        projectedPoints.push({
                            x: projectedBalance,
                            y: 50
                        });
                        
                        // Check if we've crossed any milestones
                        remainingMilestones.forEach(milestone => {
                            if (projectedBalance >= milestone && !timeToMilestones[milestone]) {
                                timeToMilestones[milestone] = i;
                            }
                        });
                    }

                    console.log('Time to milestones:', timeToMilestones);

                    // Add projection dataset
                    milestoneChart.data.datasets.push({
                        label: 'Projection',
                        data: projectedPoints,
                        borderColor: 'rgba(128, 128, 128, 0.5)',
                        borderDash: [5, 5],
                        pointStyle: 'circle',
                        pointRadius: 3,
                        pointHoverRadius: 5,
                    });
                    
                    // Update milestone info with projected timeline
                    const milestoneInfo = document.querySelector('#milestoneChart').parentNode.querySelector('.text-center');
                    console.log('Found milestone info element:', milestoneInfo);
                    
                    if (milestoneInfo) {
                        // Remove existing projection info if it exists
                        const existingProjection = milestoneInfo.querySelector('.projection-info');
                        if (existingProjection) {
                            existingProjection.remove();
                        }

                        const timelineHtml = Object.entries(timeToMilestones)
                            .map(([milestone, months]) => {
                                const years = Math.floor(months / 12);
                                const remainingMonths = months % 12;
                                const timeString = years > 0 
                                    ? `${years} year${years > 1 ? 's' : ''}${remainingMonths > 0 ? ` and ${remainingMonths} month${remainingMonths > 1 ? 's' : ''}` : ''}`
                                    : `${remainingMonths} month${remainingMonths > 1 ? 's' : ''}`;
                                return `<div class="mt-2">
                                    <span class="badge bg-info">$${parseInt(milestone).toLocaleString()}</span>
                                    <span class="ms-2"> ${timeString}</span>
                                </div>`;
                            })
                            .join('');

                        console.log('Generated timeline HTML:', timelineHtml);

                        const monthlyGrowthFormatted = new Intl.NumberFormat('en-US', {
                            style: 'currency',
                            currency: 'USD',
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        }).format(monthlyGrowth);

                        const projectionInfo = `
                            <div class="projection-info mt-4 pt-3 border-top">
                                <div class="text-muted mb-2">Based on historical average monthly growth: ${monthlyGrowthFormatted}</div>
                                <div class="h5 mb-3">Projected Timeline to Milestones:</div>
                                ${timelineHtml}
                                <div class="small text-muted mt-3">
                                    * Projections based on historical performance. Actual results may vary.
                                </div>
                            </div>
                        `;
                        
                        console.log('Adding projection info to milestone info element');
                        milestoneInfo.insertAdjacentHTML('beforeend', projectionInfo);
                    } else {
                        console.error('Could not find milestone info element to add timeline to');
                    }
                } catch (error) {
                    console.error('Error calculating projection:', error);
                    // Show error message to user
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'alert alert-danger mt-3';
                    errorDiv.textContent = 'Failed to calculate projection: ' + error.message;
                    document.querySelector('#milestoneChart').parentNode.appendChild(errorDiv);
                }
            } else {
                // Remove projection dataset
                milestoneChart.data.datasets = milestoneChart.data.datasets.slice(0, 2);
                
                // Remove projection info
                const milestoneInfo = document.querySelector('#milestoneChart').parentNode.querySelector('.text-center');
                if (milestoneInfo) {
                    const projectionInfo = milestoneInfo.querySelector('.projection-info');
                    if (projectionInfo) {
                        projectionInfo.remove();
                    }
                }
            }
            milestoneChart.update();
        });
    </script>
</body>
</html>