<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Personal Finance Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bank-themes.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .setup-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 0;
        }
        
        .setup-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            max-width: 900px;
            width: 100%;
        }
        
        .setup-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
        }
        
        .setup-header h1 {
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .setup-header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 0;
        }
        
        .setup-body {
            padding: 3rem 2rem;
        }
        
        .bank-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .bank-card {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: white;
        }
        
        .bank-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .bank-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
        }
        
        .bank-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
        }
        
        .bank-logo img {
            max-width: 60px;
            max-height: 60px;
        }
        
        .bank-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .bank-description {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
        }
        
        .setup-instructions {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 2rem 0;
        }
        
        .setup-instructions h5 {
            color: #495057;
            margin-bottom: 1rem;
        }
        
        .folder-structure {
            background: #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 1rem 0;
        }
        
        .btn-setup {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-setup:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: white;
        }
        
        .btn-setup:disabled {
            opacity: 0.6;
            transform: none;
            box-shadow: none;
        }
        
        .step-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 0 1rem;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 0.5rem;
        }
        
        .step.active .step-number {
            background: #28a745;
        }
        
        .step.completed .step-number {
            background: #28a745;
        }
        
        .step-text {
            font-weight: 500;
            color: #495057;
        }
        
        .step.active .step-text {
            color: #28a745;
        }
        
        .step.completed .step-text {
            color: #28a745;
        }
        
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f8f9fa;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background: #e8f2ff;
        }
        
        .file-list {
            margin-top: 1rem;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            background: white;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            border: 1px solid #e9ecef;
        }
        
        .file-item .file-name {
            flex: 1;
            margin-right: 1rem;
        }
        
        .file-item .file-size {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .file-item .remove-file {
            color: #dc3545;
            cursor: pointer;
            padding: 0.25rem;
        }
        
        .account-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .account-type-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            background: white;
        }
        
        .account-type-card h6 {
            margin-bottom: 0.5rem;
            color: #495057;
        }
        
        .account-type-card .description {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }
        
        .account-management-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 1rem 0;
        }
        
        .account-type-management-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            background: white;
        }
        
        .account-type-management-card h6 {
            margin-bottom: 1rem;
            color: #495057;
            font-weight: 600;
        }
        
        .account-list {
            margin-bottom: 1rem;
        }
        
        .account-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid #e9ecef;
        }
        
        .account-item.editing {
            background: white;
            border-color: #667eea;
        }
        
        .account-name {
            flex: 1;
            font-weight: 500;
            color: #495057;
        }
        
        .account-name-input {
            flex: 1;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 0.375rem 0.75rem;
            font-size: 0.9rem;
        }
        
        .account-actions {
            display: flex;
            gap: 0.25rem;
        }
        
        .btn-account-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-edit {
            background: #007bff;
            color: white;
        }
        
        .btn-edit:hover {
            background: #0056b3;
        }
        
        .btn-save {
            background: #28a745;
            color: white;
        }
        
        .btn-save:hover {
            background: #1e7e34;
        }
        
        .btn-cancel {
            background: #6c757d;
            color: white;
        }
        
        .btn-cancel:hover {
            background: #545b62;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .progress-bar {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .success-message {
            text-align: center;
            padding: 2rem;
        }
        
        .success-message i {
            font-size: 4rem;
            color: #28a745;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <div class="setup-card">
            <div class="setup-header">
                <h1><i class="bi bi-wallet2 me-2"></i>Welcome to Personal Finance Tracker</h1>
                <p>Let's get you started by setting up your bank configuration</p>
            </div>
            
            <div class="setup-body">
                <div class="step-indicator">
                    <div class="step active" id="step-1">
                        <div class="step-number">1</div>
                        <div class="step-text">Your Name</div>
                    </div>
                    <div class="step" id="step-2">
                        <div class="step-number">2</div>
                        <div class="step-text">Choose Bank</div>
                    </div>
                    <div class="step" id="step-3">
                        <div class="step-number">3</div>
                        <div class="step-text">Create Folders</div>
                    </div>
                    <div class="step" id="step-4">
                        <div class="step-number">4</div>
                        <div class="step-text">Manage Accounts</div>
                    </div>
                    <div class="step" id="step-5">
                        <div class="step-number">5</div>
                        <div class="step-text">Upload Statements</div>
                    </div>
                    <div class="step" id="step-6">
                        <div class="step-number">6</div>
                        <div class="step-text">Complete</div>
                    </div>
                </div>
                
                <!-- Step 1: User Name -->
                <div class="step-content active" id="step-1-content">
                <h4 class="text-center mb-4">Step 1: Welcome! What should we call you?</h4>
                <p class="text-center text-muted mb-4">Please enter your name or nickname. This will be used to personalize your dashboard experience.</p>
                
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="mb-4">
                            <label for="user-name" class="form-label">Your Name</label>
                            <input type="text" class="form-control form-control-lg" id="user-name" placeholder="Enter your name or nickname" maxlength="50">
                            <div class="form-text">This will be used in your dashboard headers and personalization.</div>
                        </div>
                    </div>
                </div>
                
                                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-setup" onclick="nextStep()" id="next-step-1" disabled>
                            <i class="bi bi-arrow-right me-2"></i>Next: Choose Your Bank
                        </button>
                    </div>
                </div>
                
                <!-- Step 2: Choose Bank -->
                <div class="step-content" id="step-2-content">
                <h4 class="text-center mb-4">Step 2: Choose Your Bank</h4>
                <p class="text-center text-muted mb-4">Select your bank from the list below. This will configure the system with the correct branding and statement parsing patterns.</p>
                
                <div class="bank-grid">
                    {% for bank in banks %}
                    <div class="bank-card" data-bank="{{ bank.name }}" onclick="selectBank('{{ bank.name }}')">
                        <div class="bank-logo">
                            {% if bank.logo_exists %}
                                <img src="{{ bank.logo_path }}" alt="{{ bank.display_name }} Logo">
                            {% else %}
                                <i class="bi bi-bank" style="font-size: 2rem; color: #6c757d;"></i>
                            {% endif %}
                        </div>
                        <div class="bank-name">{{ bank.display_name }}</div>
                        <div class="bank-description">
                            {% if bank.name == 'scotiabank' %}
                                Canadian bank with red and navy branding
                            {% elif bank.name == 'barclays' %}
                                UK bank with blue and gold branding
                            {% else %}
                                Configured bank with custom branding
                            {% endif %}
                        </div>
                        <div class="form-check d-flex justify-content-center">
                            <input class="form-check-input" type="radio" name="selectedBank" value="{{ bank.name }}" id="bank-{{ bank.name }}">
                            <label class="form-check-label ms-2" for="bank-{{ bank.name }}">
                                Select {{ bank.display_name }}
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-setup" onclick="nextStep()" id="next-step-2" disabled>
                            <i class="bi bi-arrow-right me-2"></i>Next: Create Folders
                        </button>
                        <button class="btn btn-outline-secondary" onclick="previousStep()">
                            <i class="bi bi-arrow-left me-2"></i>Back
                        </button>
                    </div>
                </div>
                
                <!-- Step 3: Create Folders -->
                <div class="step-content" id="step-3-content">
                    <h4 class="text-center mb-4">Step 3: Create Folder Structure</h4>
                    <p class="text-center text-muted mb-4">We'll create the necessary folders for your <span id="selected-bank-name-3"></span> statements.</p>
                    
                    <div class="setup-instructions">
                        <h5><i class="bi bi-info-circle me-2"></i>Folder Structure for <span id="selected-bank-name-3"></span></h5>
                        <p>The following folder structure will be created:</p>
                    
                    <div class="folder-structure" id="folder-structure">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-lightbulb me-2"></i>
                            <strong>Tip:</strong> Each account type folder will contain a README file with instructions for organizing your statements.
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-setup" onclick="createFolders()" id="create-folders-btn">
                            <i class="bi bi-folder-plus me-2"></i>Create Folder Structure
                        </button>
                        <button class="btn btn-outline-secondary" onclick="previousStep()">
                            <i class="bi bi-arrow-left me-2"></i>Back
                        </button>
                    </div>
                </div>
                
                                 <!-- Step 4: Manage Accounts -->
                 <div class="step-content" id="step-4-content">
                     <h4 class="text-center mb-4">Step 4: Manage Account Folders</h4>
                     <p class="text-center text-muted mb-4">Configure and manage the account folders for your <span id="selected-bank-name-4"></span> statements.</p>
                     
                     <div class="alert alert-info">
                         <i class="bi bi-info-circle me-2"></i>
                         <strong>Tip:</strong> Rename the default folders to match your actual account names. You need at least one account per type to continue.
                     </div>
                     
                     <div class="account-management-grid">
                         <div class="account-type-management-card">
                             <h6><i class="bi bi-credit-card me-2"></i>Credit Cards</h6>
                             <div class="account-list" id="credit-accounts">
                                 <!-- Will be populated by JavaScript -->
                             </div>
                             <button class="btn btn-outline-primary btn-sm mt-2" onclick="addAccount('credit')">
                                 <i class="bi bi-plus-circle me-1"></i>Add Credit Account
                             </button>
                         </div>
                         
                         <div class="account-type-management-card">
                             <h6><i class="bi bi-bank me-2"></i>Chequing Accounts</h6>
                             <div class="account-list" id="chequing-accounts">
                                 <!-- Will be populated by JavaScript -->
                             </div>
                             <button class="btn btn-outline-primary btn-sm mt-2" onclick="addAccount('chequing')">
                                 <i class="bi bi-plus-circle me-1"></i>Add Chequing Account
                             </button>
                         </div>
                         
                         <div class="account-type-management-card">
                             <h6><i class="bi bi-piggy-bank me-2"></i>Savings Accounts</h6>
                             <div class="account-list" id="savings-accounts">
                                 <!-- Will be populated by JavaScript -->
                             </div>
                             <button class="btn btn-outline-primary btn-sm mt-2" onclick="addAccount('savings')">
                                 <i class="bi bi-plus-circle me-1"></i>Add Savings Account
                             </button>
                         </div>
                     </div>
                     
                     <div class="d-grid gap-2 mt-4">
                         <button class="btn btn-setup" onclick="nextStep()" id="next-step-3" disabled>
                             <i class="bi bi-arrow-right me-2"></i>Next: Upload Statements
                         </button>
                         <button class="btn btn-outline-secondary" onclick="previousStep()">
                             <i class="bi bi-arrow-left me-2"></i>Back
                         </button>
                     </div>
                 </div>
                
                <!-- Step 5: Upload Statements -->
                <div class="step-content" id="step-5-content">
                    <h4 class="text-center mb-4">Step 5: Upload Bank Statements</h4>
                    <p class="text-center text-muted mb-4" id="upload-description">Upload your PDF bank statements to the appropriate accounts.</p>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Tip:</strong> Select the specific account for each file you upload. Files will be organized in the correct account folders.
                    </div>
                    
                    <div class="account-type-grid">
                        <div class="account-type-card">
                            <h6><i class="bi bi-credit-card me-2"></i>Credit Cards</h6>
                            <div class="description">Credit card statements and transactions</div>
                            
                            <div class="mb-3">
                                <label class="form-label">Select Account:</label>
                                <select class="form-select" id="credit-account-select">
                                    <option value="">Choose an account...</option>
                                </select>
                            </div>
                            
                            <div class="upload-area" onclick="document.getElementById('credit-upload').click()" ondrop="handleDrop(event, 'credit')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                                <i class="bi bi-cloud-upload" style="font-size: 2rem; color: #6c757d;"></i>
                                <p class="mt-2 mb-0" id="credit-upload-text">Click or drag PDF files here</p>
                                <input type="file" id="credit-upload" multiple accept=".pdf,.csv" style="display: none;" onchange="handleFileSelect(event, 'credit')">
                            </div>
                            <div class="file-list" id="credit-files"></div>
                        </div>
                        
                        <div class="account-type-card">
                            <h6><i class="bi bi-bank me-2"></i>Chequing Accounts</h6>
                            <div class="description">Current account statements and transactions</div>
                            
                            <div class="mb-3">
                                <label class="form-label">Select Account:</label>
                                <select class="form-select" id="chequing-account-select">
                                    <option value="">Choose an account...</option>
                                </select>
                            </div>
                            
                            <div class="upload-area" onclick="document.getElementById('chequing-upload').click()" ondrop="handleDrop(event, 'chequing')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                                <i class="bi bi-cloud-upload" style="font-size: 2rem; color: #6c757d;"></i>
                                <p class="mt-2 mb-0" id="chequing-upload-text">Click or drag PDF files here</p>
                                <input type="file" id="chequing-upload" multiple accept=".pdf,.csv" style="display: none;" onchange="handleFileSelect(event, 'chequing')">
                            </div>
                            <div class="file-list" id="chequing-files"></div>
                        </div>
                        
                        <div class="account-type-card">
                            <h6><i class="bi bi-piggy-bank me-2"></i>Savings Accounts</h6>
                            <div class="description">Savings account statements and transactions</div>
                            
                            <div class="mb-3">
                                <label class="form-label">Select Account:</label>
                                <select class="form-select" id="savings-account-select">
                                    <option value="">Choose an account...</option>
                                </select>
                            </div>
                            
                            <div class="upload-area" onclick="document.getElementById('savings-upload').click()" ondrop="handleDrop(event, 'savings')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                                <i class="bi bi-cloud-upload" style="font-size: 2rem; color: #6c757d;"></i>
                                <p class="mt-2 mb-0" id="savings-upload-text">Click or drag PDF files here</p>
                                <input type="file" id="savings-upload" multiple accept=".pdf,.csv" style="display: none;" onchange="handleFileSelect(event, 'savings')">
                            </div>
                            <div class="file-list" id="savings-files"></div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-setup" onclick="uploadFiles()" id="upload-btn" disabled>
                            <i class="bi bi-cloud-upload me-2"></i>Upload All Files
                        </button>
                        <button class="btn btn-outline-secondary" onclick="previousStep()">
                            <i class="bi bi-arrow-left me-2"></i>Back
                        </button>
                    </div>
                </div>
                
                <!-- Step 6: Complete -->
                <div class="step-content" id="step-6-content">
                    <div class="success-message">
                        <i class="bi bi-check-circle"></i>
                        <h4>Setup Complete!</h4>
                        <p class="text-muted">Your bank configuration has been set up successfully. You can now start analyzing your financial data.</p>
                        <button class="btn btn-setup" onclick="completeSetup()">
                            <i class="bi bi-arrow-right me-2"></i>Go to Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedBank = null;
        let userName = '';
        let currentStep = 1;
        let uploadedFiles = {
            credit: [],
            chequing: [],
            savings: []
        };
        let accountFolders = {
            credit: [],
            chequing: [],
            savings: []
        };
        
        // Add event listener for user name input
        document.addEventListener('DOMContentLoaded', function() {
            const userNameInput = document.getElementById('user-name');
            const nextStep1Btn = document.getElementById('next-step-1');
            
            userNameInput.addEventListener('input', function() {
                const name = this.value.trim();
                nextStep1Btn.disabled = name.length === 0;
            });
        });
        
        function selectBank(bankName) {
            // Remove previous selection
            document.querySelectorAll('.bank-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            const card = document.querySelector(`[data-bank="${bankName}"]`);
            card.classList.add('selected');
            
            // Check the radio button
            document.getElementById(`bank-${bankName}`).checked = true;
            
            selectedBank = bankName;
            
            // Enable next button for step 2
            document.getElementById('next-step-2').disabled = false;
            
            // Update upload text based on bank file format
            updateUploadTextForBank(bankName);
        }
        
        function nextStep() {
            // Validate current step before proceeding
            if (currentStep === 1) {
                const nameInput = document.getElementById('user-name');
                const name = nameInput.value.trim();
                if (name.length === 0) {
                    alert('Please enter your name to continue.');
                    return;
                }
                userName = name;
            }
            
            if (currentStep < 6) { // Updated to 6 for the new step
                currentStep++;
                updateStepDisplay();
            }
        }
        
        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }
        
        function updateStepDisplay() {
            // Hide all step contents
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show current step content
            document.getElementById(`step-${currentStep}-content`).classList.add('active');
            
            // Update step indicators
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < currentStep) {
                    step.classList.add('completed');
                } else if (index + 1 === currentStep) {
                    step.classList.add('active');
                }
            });
            
            // Update content based on step
            if (currentStep === 2) {
                // Bank selection step - no special handling needed
            } else if (currentStep === 3) {
                showFolderStructure();
            } else if (currentStep === 4) {
                loadAccountFolders();
            } else if (currentStep === 5) {
                populateAccountDropdowns();
            }
        }
        
        function showFolderStructure() {
            const bankNameSpan2 = document.getElementById('selected-bank-name-2');
            const bankNameSpan3 = document.getElementById('selected-bank-name-3');
            const folderStructure = document.getElementById('folder-structure');
            
            // Get bank display name
            const bankCard = document.querySelector(`[data-bank="${selectedBank}"]`);
            const displayName = bankCard.querySelector('.bank-name').textContent;
            
            bankNameSpan2.textContent = displayName;
            bankNameSpan3.textContent = displayName;
            
            // Create folder structure example
            let fileType = 'PDF statements here';
            if (selectedBank === 'barclays') {
                fileType = 'CSV statements here';
            }
            
            const structure = `bank_statements/
└── ${selectedBank}/
    ├── Credit/
    │   └── YourCreditCard/
    │       └── (${fileType})
    ├── Chequing/
    │   └── YourChequingAccount/
    │       └── (${fileType})
    └── Savings/
        └── YourSavingsAccount/
            └── (${fileType})`;
            
            folderStructure.textContent = structure;
        }
        
        function createFolders() {
            if (!selectedBank) {
                alert('Please select a bank first');
                return;
            }
            
            // Disable the button and show loading state
            const createBtn = document.getElementById('create-folders-btn');
            const originalText = createBtn.innerHTML;
            createBtn.disabled = true;
            createBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Creating Folders...';
            
            // Call the API to create folders
            fetch('/create-folders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    bank_name: selectedBank
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Move to next step
                    nextStep();
                } else {
                    // Show error message
                    alert('Error creating folders: ' + data.error);
                    createBtn.disabled = false;
                    createBtn.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating folders. Please try again.');
                createBtn.disabled = false;
                createBtn.innerHTML = originalText;
            });
        }
        
        function handleFileSelect(event, accountType) {
            const files = Array.from(event.target.files);
            addFilesToAccountType(files, accountType);
        }
        
        function handleDrop(event, accountType) {
            event.preventDefault();
            const files = Array.from(event.dataTransfer.files);
            addFilesToAccountType(files, accountType);
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }
        
        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }
        
        function addFilesToAccountType(files, accountType) {
            // Filter files based on selected bank's file format
            let allowedFiles = [];
            
            if (selectedBank === 'barclays') {
                // Barclays supports CSV files
                allowedFiles = files.filter(file => file.type === 'text/csv' || file.name.toLowerCase().endsWith('.csv'));
            } else {
                // Other banks support PDF files
                allowedFiles = files.filter(file => file.type === 'application/pdf');
            }
            
            uploadedFiles[accountType] = uploadedFiles[accountType].concat(allowedFiles);
            updateFileList(accountType);
            updateUploadButton();
        }
        
        function updateFileList(accountType) {
            const fileList = document.getElementById(`${accountType}-files`);
            fileList.innerHTML = '';
            
            uploadedFiles[accountType].forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${formatFileSize(file.size)}</div>
                    <div class="remove-file" onclick="removeFile('${accountType}', ${index})">
                        <i class="bi bi-x-circle"></i>
                    </div>
                `;
                fileList.appendChild(fileItem);
            });
        }
        
        function removeFile(accountType, index) {
            uploadedFiles[accountType].splice(index, 1);
            updateFileList(accountType);
            updateUploadButton();
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function updateUploadButton() {
            const totalFiles = uploadedFiles.credit.length + uploadedFiles.chequing.length + uploadedFiles.savings.length;
            const uploadBtn = document.getElementById('upload-btn');
            uploadBtn.disabled = totalFiles === 0;
        }
        
        function uploadFiles() {
            const totalFiles = uploadedFiles.credit.length + uploadedFiles.chequing.length + uploadedFiles.savings.length;
            if (totalFiles === 0) {
                alert('Please select at least one file to upload');
                return;
            }
            
            // Check if all files have selected accounts
            const accountTypes = ['credit', 'chequing', 'savings'];
            const missingAccounts = [];
            
            accountTypes.forEach(accountType => {
                if (uploadedFiles[accountType].length > 0) {
                    const selectedAccount = document.getElementById(`${accountType}-account-select`).value;
                    if (!selectedAccount) {
                        missingAccounts.push(accountType);
                    }
                }
            });
            
            if (missingAccounts.length > 0) {
                alert(`Please select accounts for: ${missingAccounts.join(', ')}`);
                return;
            }
            
            const uploadBtn = document.getElementById('upload-btn');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Uploading...';
            
            // Create FormData for each account type
            const promises = [];
            
            accountTypes.forEach(accountType => {
                if (uploadedFiles[accountType].length > 0) {
                    const selectedAccount = document.getElementById(`${accountType}-account-select`).value;
                    const formData = new FormData();
                    formData.append('bank_name', selectedBank);
                    formData.append('account_type', accountType);
                    formData.append('account_name', selectedAccount);
                    
                    uploadedFiles[accountType].forEach(file => {
                        formData.append('files', file);
                    });
                    
                    promises.push(
                        fetch('/upload-statements', {
                            method: 'POST',
                            body: formData
                        }).then(response => response.json())
                    );
                }
            });
            
            Promise.all(promises)
                .then(results => {
                    const allSuccess = results.every(result => result.success);
                    if (allSuccess) {
                        nextStep();
                    } else {
                        const errors = results.filter(result => !result.success).map(result => result.error).join(', ');
                        alert('Error uploading files: ' + errors);
                        uploadBtn.disabled = false;
                        uploadBtn.innerHTML = originalText;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error uploading files. Please try again.');
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = originalText;
                });
        }
        
        function completeSetup() {
            // Send user name to server for storage
            fetch('/save-user-name', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_name: userName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '/';
                } else {
                    console.error('Error saving user name:', data.error);
                    // Still redirect even if saving fails
                    window.location.href = '/';
                }
            })
            .catch(error => {
                console.error('Error saving user name:', error);
                // Still redirect even if saving fails
                window.location.href = '/';
            });
        }
        
        function updateUploadTextForBank(bankName) {
            const accountTypes = ['credit', 'chequing', 'savings'];
            let uploadText = 'Click or drag PDF files here';
            let descriptionText = 'Upload your PDF bank statements to the appropriate accounts.';
            
            // Check if this is Barclays (CSV format)
            if (bankName === 'barclays') {
                uploadText = 'Click or drag CSV files here';
                descriptionText = 'Upload your CSV bank statements to the appropriate accounts.';
            }
            
            accountTypes.forEach(accountType => {
                const textElement = document.getElementById(`${accountType}-upload-text`);
                if (textElement) {
                    textElement.textContent = uploadText;
                }
            });
            
            // Update step description
            const descriptionElement = document.getElementById('upload-description');
            if (descriptionElement) {
                descriptionElement.textContent = descriptionText;
            }
        }
        
        function loadAccountFolders() {
            // Load existing account folders for each account type
            const accountTypes = ['credit', 'chequing', 'savings'];
            
            accountTypes.forEach(accountType => {
                fetch(`/api/accounts/${selectedBank}/${accountType}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            accountFolders[accountType] = data.accounts;
                            renderAccountList(accountType);
                        }
                    })
                    .catch(error => {
                        console.error(`Error loading ${accountType} accounts:`, error);
                        // Use default folders if API fails
                        accountFolders[accountType] = accountType === 'credit' ? ['YourCreditCard'] : 
                                                    accountType === 'chequing' ? ['YourChequingAccount'] : 
                                                    ['YourSavingsAccount'];
                        renderAccountList(accountType);
                    });
            });
            
            // Update bank name display
            const bankCard = document.querySelector(`[data-bank="${selectedBank}"]`);
            const displayName = bankCard.querySelector('.bank-name').textContent;
            document.getElementById('selected-bank-name-4').textContent = displayName;
        }
        
        function renderAccountList(accountType) {
            const container = document.getElementById(`${accountType}-accounts`);
            container.innerHTML = '';
            
            accountFolders[accountType].forEach((accountName, index) => {
                const accountItem = document.createElement('div');
                accountItem.className = 'account-item';
                accountItem.innerHTML = `
                    <div class="account-name">${accountName}</div>
                    <div class="account-actions">
                        <button class="btn-account-action btn-edit" onclick="editAccount('${accountType}', ${index})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        ${accountFolders[accountType].length > 1 ? `
                            <button class="btn-account-action btn-delete" onclick="deleteAccount('${accountType}', ${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(accountItem);
            });
            
            updateNextButton();
        }
        
        function addAccount(accountType) {
            const newName = prompt(`Enter name for new ${accountType} account:`);
            if (!newName || newName.trim() === '') return;
            
            fetch(`/api/accounts/${selectedBank}/${accountType}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    account_name: newName.trim()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    accountFolders[accountType].push(newName.trim());
                    renderAccountList(accountType);
                } else {
                    alert('Error creating account: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error creating account:', error);
                alert('Error creating account. Please try again.');
            });
        }
        
        function editAccount(accountType, index) {
            const accountItem = document.querySelector(`#${accountType}-accounts .account-item:nth-child(${index + 1})`);
            const accountName = accountFolders[accountType][index];
            
            accountItem.className = 'account-item editing';
            accountItem.innerHTML = `
                <input type="text" class="account-name-input" value="${accountName}" id="edit-${accountType}-${index}">
                <div class="account-actions">
                    <button class="btn-account-action btn-save" onclick="saveAccount('${accountType}', ${index})">
                        <i class="bi bi-check"></i>
                    </button>
                    <button class="btn-account-action btn-cancel" onclick="cancelEdit('${accountType}', ${index})">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
            
            // Focus on input
            document.getElementById(`edit-${accountType}-${index}`).focus();
        }
        
        function saveAccount(accountType, index) {
            const input = document.getElementById(`edit-${accountType}-${index}`);
            const newName = input.value.trim();
            const oldName = accountFolders[accountType][index];
            
            if (!newName || newName === oldName) {
                cancelEdit(accountType, index);
                return;
            }
            
            fetch(`/api/accounts/${selectedBank}/${accountType}/${oldName}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    new_name: newName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    accountFolders[accountType][index] = newName;
                    renderAccountList(accountType);
                } else {
                    alert('Error renaming account: ' + data.error);
                    cancelEdit(accountType, index);
                }
            })
            .catch(error => {
                console.error('Error renaming account:', error);
                alert('Error renaming account. Please try again.');
                cancelEdit(accountType, index);
            });
        }
        
        function cancelEdit(accountType, index) {
            renderAccountList(accountType);
        }
        
        function deleteAccount(accountType, index) {
            const accountName = accountFolders[accountType][index];
            if (!confirm(`Are you sure you want to delete the account "${accountName}"?`)) return;
            
            fetch(`/api/accounts/${selectedBank}/${accountType}/${accountName}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    accountFolders[accountType].splice(index, 1);
                    renderAccountList(accountType);
                } else {
                    alert('Error deleting account: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error deleting account:', error);
                alert('Error deleting account. Please try again.');
            });
        }
        
        function updateNextButton() {
            const hasAccounts = accountFolders.credit.length > 0 && 
                               accountFolders.chequing.length > 0 && 
                               accountFolders.savings.length > 0;
            
            const nextBtn = document.getElementById('next-step-3');
            nextBtn.disabled = !hasAccounts;
        }
        
        function populateAccountDropdowns() {
            // Populate account dropdowns for upload step
            const accountTypes = ['credit', 'chequing', 'savings'];
            
            accountTypes.forEach(accountType => {
                const select = document.getElementById(`${accountType}-account-select`);
                select.innerHTML = '<option value="">Choose an account...</option>';
                
                accountFolders[accountType].forEach(accountName => {
                    const option = document.createElement('option');
                    option.value = accountName;
                    option.textContent = accountName;
                    select.appendChild(option);
                });
            });
        }
    </script>
</body>
</html> 